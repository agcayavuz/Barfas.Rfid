<!doctype html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>RFID Demo (WebSocket)</title>
    <style>
        :root {
            --bezel: #222;
            --bezel2: #111;
            --screen: #f6f7fb;
            --accent: #5b8cff;
            --ok: #22c55e;
            --warn: #f59e0b;
            --text: #0f172a;
            --muted: #64748b;
            --line: #e5e7eb;
        }

        body {
            background: #eceff3;
            font: 14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;
            margin: 24px;
            display: flex;
            justify-content: center
        }

        .device {
            width: 420px;
            border-radius: 28px;
            background: linear-gradient(145deg,var(--bezel),var(--bezel2));
            padding: 18px 18px 24px;
            box-shadow: 0 16px 40px rgba(0,0,0,.25), inset 0 0 0 2px #0006;
        }

        .speaker {
            height: 6px;
            width: 120px;
            background: #000;
            opacity: .3;
            border-radius: 6px;
            margin: 6px auto 16px
        }

        .screen {
            background: var(--screen);
            border-radius: 16px;
            padding: 16px;
            box-shadow: inset 0 1px 0 #fff, inset 0 0 0 1px #00000010;
            min-height: 520px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        h1 {
            font-size: 18px;
            margin: 0;
            color: var(--text);
            text-align: center
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center
        }

        .badge {
            background: #eef2ff;
            color: #2b3a67;
            border-radius: 999px;
            padding: 6px 10px;
            font-weight: 600
        }

        .muted {
            color: var(--muted)
        }

        input[type=number] {
            width: 80px;
            padding: 8px;
            border: 1px solid var(--line);
            border-radius: 10px;
            background: #fff
        }

        button {
            padding: 9px 14px;
            border: 0;
            border-radius: 12px;
            background: #fff;
            box-shadow: 0 1px 0 #fff, 0 0 0 1px #00000010, 0 6px 16px #00000010;
            cursor: pointer;
            font-weight: 600;
            color: #0f172a;
            transition: .15s
        }

            button:disabled {
                opacity: .5;
                cursor: not-allowed;
                transform: none
            }

            button.primary {
                background: var(--accent);
                color: #fff;
                box-shadow: 0 0 0 1px #00000010, 0 8px 18px rgba(91,140,255,.35)
            }

            button.danger {
                background: #ef4444;
                color: #fff
            }

        .grid {
            border: 1px solid var(--line);
            border-radius: 12px;
            overflow: auto;
            max-height: 360px;
            background: #fff
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            table-layout: fixed
        }

        thead th, tbody td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--line);
            font-size: 13px
        }

        thead th {
            font-weight: 700;
            text-align: left;
            color: #334155;
            background: #f8fafc;
            position: sticky;
            top: 0;
            z-index: 1
        }

        col.idx {
            width: 48px
        }

        col.rssi {
            width: 70px
        }

        col.seen {
            width: 60px
        }

        col.time {
            width: 88px
        }

        td.epc {
            word-break: break-all;
            font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
            letter-spacing: .2px
        }

        .status {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #94a3b8
        }

            .dot.ok {
                background: var(--ok)
            }

            .dot.warn {
                background: var(--warn)
            }

        .toast {
            position: fixed;
            left: 50%;
            bottom: 18px;
            transform: translateX(-50%);
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0;
            padding: 10px 14px;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0,0,0,.12);
            display: none;
            font-weight: 600;
        }

        .done-banner {
            display: none;
            margin-top: 4px;
            text-align: center;
            padding: 10px 12px;
            border-radius: 10px;
            background: #e6ffed;
            border: 1px solid #b7f5c6;
            color: #065f46;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="device">
        <div class="speaker"></div>
        <div class="screen">
            <h1>RFID El Terminali</h1>

            <div class="row">
                <label>Hedef:</label>
                <input id="t" type="number" min="1" value="5" />
            </div>
            <div class="row">
                <button id="btnConnect" class="primary">Bağlan</button>
                <button id="btnStart">Başlat</button>
                <button id="btnStop" class="danger">Durdur</button>
            </div>

            <div class="row status">
                <span class="dot" id="dot"></span>
                <span id="status" class="muted">disconnected</span>
                <span class="badge"><span id="cur">0</span> / <span id="tgt">0</span></span>
            </div>

            <div class="grid" id="scroller">
                <table>
                    <colgroup><col class="idx"><col class="epc"><col class="rssi"><col class="seen"><col class="time"></colgroup>
                    <thead><tr><th>#</th><th>EPC</th><th>RSSI</th><th>Seen</th><th>Zaman</th></tr></thead>
                    <tbody id="rows"></tbody>
                </table>
            </div>

            <div id="doneBanner" class="done-banner">Yeterli Sayıda Etiket Okunmuştur</div>

            <div class="muted" style="text-align:center">Önce <b>Bağlan</b>, sonra <b>Başlat</b> deyin.</div>
        </div>
    </div>

    <div class="toast" id="toast">Hedefe ulaşıldı. Yeni hedefle tekrar başlatabilirsiniz.</div>

    <script>
        (() => {
            const btnConnect = document.getElementById('btnConnect');
            const btnStart = document.getElementById('btnStart');
            const btnStop = document.getElementById('btnStop');
            const statusEl = document.getElementById('status');
            const dot = document.getElementById('dot');
            const tInput = document.getElementById('t');
            const rows = document.getElementById('rows');
            const curEl = document.getElementById('cur');
            const tgtEl = document.getElementById('tgt');
            const toast = document.getElementById('toast');
            const scroller = document.getElementById('scroller');
            const doneBanner = document.getElementById('doneBanner');

            let ws = null, idx = 0, done = false, notified = false;

            const State = Object.freeze({
                DISCONNECTED: 'DISCONNECTED', CONNECTING: 'CONNECTING',
                CONNECTED_IDLE: 'CONNECTED_IDLE', RUNNING: 'RUNNING', COMPLETED: 'COMPLETED'
            });

            function setState(s) {
                switch (s) {
                    case State.DISCONNECTED:
                        statusEl.textContent = 'disconnected'; dot.className = 'dot';
                        btnConnect.disabled = false; btnStart.disabled = true; btnStop.disabled = true;
                        doneBanner.style.display = 'none'; notified = false; break;
                    case State.CONNECTING:
                        statusEl.textContent = 'connecting…'; dot.className = 'dot warn';
                        btnConnect.disabled = true; btnStart.disabled = true; btnStop.disabled = true; break;
                    case State.CONNECTED_IDLE:
                        statusEl.textContent = 'connected'; dot.className = 'dot ok';
                        btnConnect.disabled = true; btnStart.disabled = false; btnStop.disabled = true;
                        doneBanner.style.display = 'none'; notified = false; break;
                    case State.RUNNING:
                        statusEl.textContent = 'running'; dot.className = 'dot ok';
                        btnConnect.disabled = true; btnStart.disabled = true; btnStop.disabled = false;
                        doneBanner.style.display = 'none'; notified = false; break;
                    case State.COMPLETED:
                        statusEl.textContent = 'completed'; dot.className = 'dot ok';
                        btnConnect.disabled = true; btnStart.disabled = false; btnStop.disabled = true; break;
                }
            }

            function toastShow(msg) { toast.textContent = msg || 'Hedefe ulaşıldı'; toast.style.display = 'block'; setTimeout(() => toast.style.display = 'none', 2200); }
            setState(State.DISCONNECTED); tgtEl.textContent = '0';

            function wsUrl() { const proto = location.protocol === 'https:' ? 'wss' : 'ws'; return `${proto}://${location.host}/ws/tags`; }

            async function notifyOnce() {
                if (notified) return false;
                notified = true;

                try {
                    const res = await fetch('/notify?ts=' + Date.now(), {
                        method: 'GET',
                        cache: 'no-store'
                    });

                    if (res.ok) {
                        toastShow('Sayaç servisine istek atıldı');
                        return true;
                    } else {
                        toastShow('Sayaç servisi başarısız (' + res.status + ')');
                        return false;
                    }
                } catch (e) {
                    toastShow('Sayaç servisi hatası');
                    return false;
                }
            }

            function openWS() {
                if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) return;
                setState(State.CONNECTING);
                ws = new WebSocket(wsUrl());
                ws.onopen = () => setState(State.CONNECTED_IDLE);
                ws.onclose = () => { setState(State.DISCONNECTED); curEl.textContent = '0'; tgtEl.textContent = '0'; rows.innerHTML = ''; idx = 0; done = false; };
                ws.onerror = () => { };
                ws.onmessage = (e) => {
                    const msg = JSON.parse(e.data);
                    if (msg.type === 'TagAdded' && !done) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${++idx}</td><td class="epc">${msg.epc}</td><td>${msg.rssi}</td><td>${msg.seenCount}</td><td>${new Date(msg.timestamp).toLocaleTimeString()}</td>`;
                        rows.appendChild(tr);
                        scroller.scrollTop = scroller.scrollHeight;
                    } else if (msg.type === 'ProgressUpdated') {
                        curEl.textContent = msg.current; tgtEl.textContent = msg.target;
                    } else if (msg.type === 'ThresholdReached') {
                        done = true; setState(State.COMPLETED);
                        doneBanner.style.display = 'block';
                        notifyOnce();
                    } else if (msg.type === 'Error') {
                        toastShow('Hata: ' + (msg.message || 'bilinmiyor'));
                    }
                };
            }

            btnConnect.addEventListener('click', () => openWS());
            btnStart.addEventListener('click', () => {
                if (!ws || ws.readyState !== WebSocket.OPEN) return;
                rows.innerHTML = ''; idx = 0; done = false; curEl.textContent = '0';
                const target = Math.max(1, parseInt(tInput.value || '1', 10));
                tgtEl.textContent = String(target);
                ws.send(JSON.stringify({ action: 'start', target }));
                setState(State.RUNNING);
            });
            btnStop.addEventListener('click', () => {
                if (!ws || ws.readyState !== WebSocket.OPEN) return;
                ws.send(JSON.stringify({ action: 'stop' }));
                setState(State.CONNECTED_IDLE);
            });
        })();
    </script>
</body>
</html>
